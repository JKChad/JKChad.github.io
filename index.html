<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Code Enforcement Photo Labeler</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  ::selection { background: #7c3aed44; }
  html { -webkit-text-size-adjust: 100%; }

  body {
    font-family: 'IBM Plex Sans', 'Segoe UI', sans-serif;
    background: #06060c;
    color: #e0e0e0;
    min-height: 100vh;
    min-height: -webkit-fill-available;
    -webkit-tap-highlight-color: transparent;
  }

  .mono { font-family: 'JetBrains Mono', 'Fira Code', monospace; }

  /* Header */
  .header {
    border-bottom: 1px solid #111;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
    position: sticky; top: 0; z-index: 100;
    background: #06060c;
    backdrop-filter: blur(8px);
  }
  .header-left { display: flex; align-items: center; gap: 10px; }
  .header-icon {
    width: 32px; height: 32px;
    background: linear-gradient(135deg, #7c3aed, #6366f1);
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
  }
  .header-title { font-size: 15px; font-weight: 700; letter-spacing: -0.3px; color: #f0f0f0; }
  .header-sub { font-size: 10px; color: #555; letter-spacing: 0.5px; }

  .progress-wrap { display: flex; align-items: center; gap: 10px; font-size: 12px; }
  .progress-text { color: #666; white-space: nowrap; }
  .progress-bar { width: 80px; height: 4px; background: #1a1a2e; border-radius: 2px; overflow: hidden; }
  .progress-fill { height: 100%; background: #7c3aed; border-radius: 2px; transition: all 0.4s ease; }
  .progress-fill.done { background: #4ade80; }

  /* Main */
  .main { max-width: 1100px; margin: 0 auto; padding: 16px; }

  /* Form */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    margin-bottom: 16px;
  }
  .form-label {
    font-size: 11px; color: #555; text-transform: uppercase;
    letter-spacing: 1px; display: block; margin-bottom: 4px;
  }
  .form-input {
    width: 100%; background: #0a0a15; border: 1px solid #1a1a2e;
    color: #e0e0e0; padding: 12px 14px; border-radius: 8px;
    font-size: 16px; font-family: inherit;
    -webkit-appearance: none; appearance: none;
  }
  .form-input:focus { outline: none; border-color: #6366f1; }
  .form-input.mono { font-family: 'JetBrains Mono', monospace; font-size: 14px; }
  .form-notes {
    width: 100%; background: #0a0a15; border: 1px solid #1a1a2e;
    color: #e0e0e0; padding: 12px 14px; border-radius: 8px;
    font-size: 14px; font-family: inherit; resize: vertical;
    -webkit-appearance: none; appearance: none;
  }
  .form-notes:focus { outline: none; border-color: #6366f1; }

  /* Collapsible sections */
  .section-toggle {
    background: #0a0a15; border: 1px solid #1a1a2e; border-radius: 8px;
    padding: 14px 16px; margin-bottom: 12px; cursor: pointer;
    display: flex; justify-content: space-between; align-items: center;
    -webkit-tap-highlight-color: transparent; user-select: none;
  }
  .section-toggle:active { background: #111128; }
  .section-toggle-label { font-size: 13px; font-weight: 600; color: #999; }
  .section-toggle-arrow { color: #555; font-size: 12px; transition: transform 0.2s; }
  .section-toggle-arrow.open { transform: rotate(180deg); }
  .section-content { overflow: hidden; transition: max-height 0.3s ease; }
  .section-content.collapsed { max-height: 0 !important; }

  /* API Key Section */
  .api-section {
    background: #0a0a15; border: 1px solid #1a1a2e; border-radius: 8px;
    padding: 14px 16px; margin-bottom: 16px;
  }
  .api-section.connected { border-color: #166534; background: #0a1a0a; }
  .api-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .api-row .form-input { flex: 1; min-width: 0; }
  .api-status { font-size: 12px; margin-top: 6px; }
  .api-status.ok { color: #4ade80; }
  .api-status.err { color: #f87171; }
  .api-note { font-size: 11px; color: #444; margin-top: 6px; line-height: 1.5; }
  .api-note a { color: #7c3aed; }

  /* Upload */
  .upload-zone {
    border: 2px dashed #1a1a2e; border-radius: 12px; padding: 32px 16px;
    text-align: center; cursor: pointer; margin-bottom: 16px;
    background: #08080e; transition: border-color 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  .upload-zone:hover, .upload-zone:active, .upload-zone.dragover { border-color: #7c3aed; }
  .upload-icon { font-size: 36px; margin-bottom: 8px; }
  .upload-text { font-size: 15px; color: #888; margin-bottom: 4px; }
  .upload-hint { font-size: 12px; color: #444; }

  /* Action Bar */
  .action-bar {
    display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;
    position: sticky; top: 56px; z-index: 90;
    background: #06060c; padding: 10px 0; border-bottom: 1px solid #111;
  }
  .btn {
    border: none; border-radius: 8px; padding: 12px 20px;
    font-size: 14px; font-weight: 600; cursor: pointer;
    font-family: inherit; letter-spacing: 0.3px; transition: opacity 0.2s;
    -webkit-tap-highlight-color: transparent; touch-action: manipulation;
    white-space: nowrap;
  }
  .btn:active { opacity: 0.7; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-primary { background: linear-gradient(135deg, #7c3aed, #6366f1); color: white; }
  .btn-approve { background: #14532d; color: #4ade80; }
  .btn-export { background: #1a1a2e; color: #666; }
  .btn-export.ready { background: #1e3a5f; color: #60a5fa; }
  .btn-small {
    border: none; border-radius: 6px; padding: 8px 14px;
    font-size: 13px; cursor: pointer; font-family: inherit; font-weight: 600;
    -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  }
  .photo-count { margin-left: auto; color: #444; font-size: 13px; }

  /* Photo Cards */
  .photo-list { display: flex; flex-direction: column; gap: 12px; }
  .photo-card {
    background: #0a0a0f; border: 1px solid #1a1a2e;
    border-radius: 10px; overflow: hidden; transition: all 0.3s ease;
  }
  .photo-card.all-approved { background: #0a1a0a; border-color: #1a3a1a; }
  .photo-card-inner { display: flex; flex-direction: column; }

  .photo-img-wrap {
    width: 100%; height: 220px; flex-shrink: 0;
    position: relative; overflow: hidden;
  }
  .photo-img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .photo-number {
    position: absolute; top: 10px; left: 10px;
    background: rgba(0,0,0,0.8); color: #e0e0e0;
    padding: 4px 10px; border-radius: 4px;
    font-size: 13px; font-weight: 600; letter-spacing: 0.5px;
  }
  .photo-approved-badge {
    position: absolute; top: 10px; right: 10px;
    background: #166534; color: #4ade80;
    padding: 4px 10px; border-radius: 4px;
    font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
  }
  .photo-remove {
    position: absolute; bottom: 10px; right: 10px;
    background: rgba(80,20,20,0.85); color: #f87171;
    border: none; border-radius: 6px; padding: 6px 12px;
    font-size: 12px; cursor: pointer; font-weight: 600;
    -webkit-tap-highlight-color: transparent;
  }

  .labels-panel { flex: 1; padding: 14px 16px; min-width: 0; }

  .spinner {
    width: 18px; height: 18px; border: 2px solid #333;
    border-top: 2px solid #6366f1; border-radius: 50%;
    animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .analyzing-msg { display: flex; align-items: center; gap: 12px; padding: 16px 0; color: #8b8ba0; font-size: 14px; }
  .error-msg {
    color: #f87171; font-size: 13px; padding: 12px;
    background: #1a0a0a; border-radius: 6px; margin-bottom: 8px;
    line-height: 1.5;
  }
  .empty-msg { color: #555; font-size: 13px; padding: 16px 0; }

  /* Label rows */
  .label-row {
    display: flex; align-items: flex-start; gap: 8px;
    padding: 10px 0; border-bottom: 1px solid #111;
  }
  .label-checkbox {
    width: 28px; height: 28px; min-width: 28px; border-radius: 4px;
    border: 2px solid #444; background: transparent; cursor: pointer;
    font-size: 14px; display: flex; align-items: center; justify-content: center;
    margin-top: 0; color: transparent; flex-shrink: 0;
    -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  }
  .label-checkbox.checked { border-color: #4ade80; background: #166534; color: #4ade80; }
  .label-content { flex: 1; min-width: 0; line-height: 1.5; }
  .label-code { color: #a78bfa; font-size: 13px; font-weight: 600; }
  .label-sep { color: #555; margin: 0 4px; }
  .label-desc { color: #c8c8d8; font-size: 13px; }
  .label-actions { display: flex; gap: 2px; flex-shrink: 0; }
  .label-actions button {
    background: none; border: none; cursor: pointer;
    font-size: 13px; padding: 6px 8px; font-family: inherit;
    -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  }
  .label-edit-btn { color: #666; }
  .label-remove-btn { color: #662222; }

  /* Edit row */
  .edit-row {
    display: flex; gap: 6px; align-items: flex-start; flex-wrap: wrap;
    background: #111128; padding: 10px; border-radius: 6px; margin-bottom: 6px;
  }
  .edit-input {
    background: #0a0a1a; border: 1px solid #2a2a4e; color: #e0e0e0;
    padding: 10px 12px; border-radius: 6px; font-size: 14px;
    -webkit-appearance: none; appearance: none;
  }
  .edit-input:focus { outline: none; border-color: #6366f1; }
  .edit-code { width: 100%; }
  .edit-desc { width: 100%; }
  .edit-actions { display: flex; gap: 6px; width: 100%; }
  .edit-save { background: #166534; color: #4ade80; flex: 1; }
  .edit-cancel { background: #333; color: #999; flex: 1; }

  /* Add label */
  .add-row {
    display: flex; gap: 6px; flex-direction: column;
    margin-top: 8px; padding: 12px; background: #111128; border-radius: 6px;
  }
  .add-select {
    background: #0a0a1a; border: 1px solid #2a2a4e; color: #e0e0e0;
    padding: 10px 12px; border-radius: 6px; font-size: 14px; width: 100%;
    -webkit-appearance: none; appearance: none;
  }
  .add-select:focus { outline: none; border-color: #6366f1; }
  .add-actions { display: flex; gap: 6px; }

  .label-footer { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
  .btn-add-label {
    background: none; border: 1px dashed #2a2a4e; color: #666;
    border-radius: 6px; padding: 8px 14px; font-size: 13px; cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-approve-all {
    background: #14532d; border: none; color: #4ade80; border-radius: 6px;
    padding: 8px 14px; font-size: 13px; cursor: pointer; font-weight: 600;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-reanalyze {
    background: none; border: 1px solid #2a2a4e; color: #666;
    border-radius: 6px; padding: 8px 14px; font-size: 13px; cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }

  /* Export Preview */
  .export-section {
    margin-top: 24px; background: #08080e;
    border: 1px solid #1a1a2e; border-radius: 10px; overflow: hidden;
  }
  .export-header {
    padding: 12px 16px; border-bottom: 1px solid #1a1a2e;
    font-size: 12px; color: #666; text-transform: uppercase;
    letter-spacing: 1px; font-weight: 600;
  }
  .export-pre {
    padding: 16px; margin: 0; font-size: 11px;
    font-family: 'JetBrains Mono', monospace; color: #888;
    line-height: 1.7; overflow-x: auto; white-space: pre-wrap;
    max-height: 300px; overflow-y: auto;
  }

  .footer {
    margin-top: 32px; padding: 20px 0;
    border-top: 1px solid #111; font-size: 11px;
    color: #333; text-align: center; line-height: 1.5;
  }

  .hidden { display: none; }

  /* =========== TABLET+ (768px) =========== */
  @media (min-width: 768px) {
    .header { padding: 16px 24px; }
    .main { padding: 24px; }
    .form-grid { grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .photo-card-inner { flex-direction: row; }
    .photo-img-wrap { width: 340px; height: auto; min-height: 240px; }
    .labels-panel { padding: 16px 20px; }
    .edit-code { width: 180px; }
    .edit-desc { width: auto; flex: 1; min-width: 200px; }
    .edit-actions { width: auto; }
    .edit-row { flex-wrap: nowrap; }
    .add-row { flex-direction: row; flex-wrap: wrap; align-items: flex-start; }
    .add-select { max-width: 280px; }
    .label-checkbox { width: 22px; height: 22px; min-width: 22px; font-size: 12px; }
    .progress-bar { width: 120px; }
    .action-bar { top: 58px; }
  }

  /* =========== DESKTOP (1024px) =========== */
  @media (min-width: 1024px) {
    .photo-img-wrap { width: 380px; }
    .upload-zone { padding: 40px 20px; }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <div class="header-icon">üèõ</div>
    <div>
      <div class="header-title">Code Enforcement Photo Labeler</div>
      <div class="header-sub">Columbus, OH ‚Äî AI-Assisted Violation Analysis</div>
    </div>
  </div>
  <div class="progress-wrap" id="progressWrap" style="display:none;">
    <span class="progress-text" id="progressText"></span>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  </div>
</div>

<div class="main">

  <!-- API Key -->
  <div class="api-section" id="apiSection">
    <div class="form-label">Anthropic API Key</div>
    <div class="api-row">
      <input type="password" class="form-input" id="apiKeyInput" placeholder="sk-ant-..." style="max-width:400px;">
      <button class="btn btn-primary" onclick="testApiKey()" style="padding:10px 16px; font-size:13px;">Connect</button>
    </div>
    <div class="api-status" id="apiStatus"></div>
    <div class="api-note">Your key stays in your browser only ‚Äî never sent anywhere except Anthropic's API. <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:#7c3aed;">Get a key ‚Üí</a></div>
  </div>

  <!-- Case Info -->
  <div class="form-grid">
    <div>
      <label class="form-label">Address</label>
      <input class="form-input" id="addressInput" placeholder="851 Clarendon">
    </div>
    <div>
      <label class="form-label">Case Number</label>
      <input class="form-input mono" id="caseInput" placeholder="2024EVH060388">
    </div>
    <div>
      <label class="form-label">Officer</label>
      <input class="form-input" id="officerInput" value="CEO Chad Gentry">
    </div>
  </div>
  <div style="margin-bottom:24px;">
    <label class="form-label">Case Notes (optional ‚Äî helps AI context)</label>
    <textarea class="form-notes" id="notesInput" rows="2" placeholder="No ownership changes. Water is off. No active permits. No improvements noted."></textarea>
  </div>

  <!-- Upload Zone -->
  <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click();">
    <div class="upload-icon">üì∏</div>
    <div class="upload-text">Drop inspection photos here or click to browse</div>
    <div class="upload-hint">Supports JPG, PNG ‚Äî upload multiple at once</div>
  </div>
  <input type="file" id="fileInput" class="hidden" multiple accept="image/*">

  <!-- Action Bar -->
  <div class="action-bar" id="actionBar" style="display:none;">
    <button class="btn btn-primary" onclick="analyzeAll()" id="analyzeAllBtn">‚ö° Analyze All Photos</button>
    <button class="btn btn-approve" onclick="approveAllPhotos()" id="approveAllBtn" style="display:none;">‚úì Approve All Labels</button>
    <button class="btn btn-export" onclick="copyExport()" id="exportBtn" style="display:none;">üìã Copy Labels to Clipboard</button>
    <span class="photo-count" id="photoCount"></span>
  </div>

  <!-- Photo List -->
  <div class="photo-list" id="photoList"></div>

  <!-- Export Preview -->
  <div class="export-section" id="exportSection" style="display:none;">
    <div class="export-header">Document Preview</div>
    <pre class="export-pre" id="exportPre"></pre>
  </div>

  <div class="footer">AI-generated labels are drafts for review ‚Äî always verify against observed conditions before court submission</div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let photos = []; // { id, file, dataUrl, labels: [{code, description, approved}], analyzing, error }
let apiKey = localStorage.getItem('ce_api_key') || '';
let idCounter = 0;

const COLUMBUS_CODES = {
  "4707.01 & 4707.03": "Vacant structure not secured or maintained in accordance with city code",
  "4525.01": "Structure not weathertight / foundation in disrepair",
  "4525.02": "Windows, doors or hatchways not weathertight or in good repair",
  "4525.03": "Stairs/porches not safe, not in sound condition or good repair",
  "4525.08": "Rain carriers (gutters/downspouts) not maintained",
  "4525.11": "Exterior not maintained (bare/exposed wood, damaged siding, soffits, peeling paint)",
  "4525.13": "Fence not maintained in good condition",
  "4525.14": "Concrete, brick or masonry not sound (chimney, sidewalk, retaining wall)",
  "4525.15": "Graffiti not removed",
  "4707.11": "Emergency secure required (structure accessible / opening found)",
  "4701.11": "Emergency action required to protect public health and safety",
  "707.03": "Solid waste / garbage / rubbish / debris on premises",
  "709.03": "High grass / weeds / rank growth (12+ inches)",
  "705.03": "Premises not clean, sanitary or fit for occupancy",
  "3332.289(1)": "Prohibited exterior storage of lumber or building materials",
  "3332.289(2)": "Prohibited exterior storage of motor vehicle, boat, trailer, or shipping container",
  "3332.289(3)": "Prohibited exterior storage of vehicle parts including tires",
  "3332.289(5)": "Prohibited exterior storage of machinery or household appliance",
  "3332.289(6)": "Prohibited exterior storage of junk",
  "3332.289(7)": "Prohibited exterior storage of salvage",
  "3332.289(8)": "Prohibited exterior storage of upholstered furniture, mattresses, or similar"
};

const SYSTEM_PROMPT = `You are a code enforcement photo analysis assistant for the City of Columbus, Ohio. Your job is to analyze inspection photos and generate draft violation labels.

AVAILABLE CODE SECTIONS:
${Object.entries(COLUMBUS_CODES).map(([code, desc]) => `- ${code}: ${desc}`).join("\n")}

INSTRUCTIONS:
1. Analyze the photo for any visible code violations
2. For each violation found, output the code section and a brief description matching the style below
3. Use the EXACT format for your output
4. Be specific about what you see (e.g., "bare/exposed wood" not just "deterioration")
5. For 3332.289 violations, combine into one line and itemize specific prohibited items
6. For vacant structures with boarded windows or signs of vacancy, always include 4707.01 & 4707.03
7. Keep descriptions concise - match the style of these real examples:
   - "4707.01 & 4707.03; Vacant structure not secured or maintained in accordance with city code."
   - "4525.11; bare/exposed wood."
   - "4525.14; damaged chimney cap."
   - "4525.13; damaged fence."
   - "3332.289; prohibited exterior storage of a door, tire, cushion."
   - "707.03; solid waste."
   - "709.03; high grass/weeds."
   - "4525.11; damaged soffits."
   - "4525.01; foundation in disrepair, missing cinder block into crawl space."
   - "4525.01; structure not weathertight, contains damaged window."

OUTPUT FORMAT:
Return ONLY a JSON array of objects, each with "code" and "description" fields. No markdown, no backticks, no explanation.
Example: [{"code":"4707.01 & 4707.03","description":"Vacant structure not secured or maintained in accordance with city code."},{"code":"4525.11","description":"bare/exposed wood."}]`;

// ============================================================
// INIT
// ============================================================
window.addEventListener('DOMContentLoaded', () => {
  if (apiKey) {
    document.getElementById('apiKeyInput').value = apiKey;
    setApiStatus('ok', 'Key loaded from previous session');
    document.getElementById('apiSection').classList.add('connected');
  }

  // File input
  document.getElementById('fileInput').addEventListener('change', (e) => {
    handleFiles(Array.from(e.target.files));
    e.target.value = '';
  });

  // Drag and drop
  const zone = document.getElementById('uploadZone');
  zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('dragover');
    handleFiles(Array.from(e.dataTransfer.files));
  });
});

// ============================================================
// API KEY
// ============================================================
async function testApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key) { setApiStatus('err', 'Please enter an API key'); return; }

  setApiStatus('', 'Testing connection...');
  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': key,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 10,
        messages: [{ role: 'user', content: 'Reply with just the word OK' }]
      })
    });

    if (resp.ok) {
      apiKey = key;
      localStorage.setItem('ce_api_key', key);
      setApiStatus('ok', '‚úì Connected successfully');
      document.getElementById('apiSection').classList.add('connected');
    } else {
      const data = await resp.json().catch(() => ({}));
      setApiStatus('err', `Connection failed: ${data.error?.message || resp.statusText}`);
    }
  } catch (err) {
    setApiStatus('err', `Connection error: ${err.message}`);
  }
}

function setApiStatus(type, msg) {
  const el = document.getElementById('apiStatus');
  el.textContent = msg;
  el.className = 'api-status' + (type ? ' ' + type : '');
}

// ============================================================
// FILE HANDLING
// ============================================================
function handleFiles(files) {
  const imageFiles = files.filter(f => f.type.startsWith('image/'));
  if (!imageFiles.length) return;

  const promises = imageFiles.map(file => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => {
        photos.push({
          id: ++idCounter,
          file: file,
          dataUrl: reader.result,
          fileName: file.name,
          labels: [],
          analyzing: false,
          error: null
        });
        resolve();
      };
      reader.readAsDataURL(file);
    });
  });

  Promise.all(promises).then(() => render());
}

// ============================================================
// ANALYSIS
// ============================================================
async function analyzePhoto(photoId) {
  const photo = photos.find(p => p.id === photoId);
  if (!photo) return;

  if (!apiKey) {
    photo.error = 'Please connect your API key first.';
    render();
    return;
  }

  photo.analyzing = true;
  photo.error = null;
  render();

  try {
    // Resize image
    const resizedBase64 = await resizeImage(photo.dataUrl, 1568, 0.85);

    const address = document.getElementById('addressInput').value;
    const caseNum = document.getElementById('caseInput').value;
    const notes = document.getElementById('notesInput').value;

    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: SYSTEM_PROMPT,
        messages: [{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: resizedBase64 } },
            { type: 'text', text: `Analyze this code enforcement inspection photo for violations. Property: ${address || 'Unknown'}. Case: ${caseNum || 'Unknown'}. ${notes ? 'Inspector notes: ' + notes : ''}\n\nReturn ONLY a valid JSON array of objects with "code" and "description" fields.` }
          ]
        }]
      })
    });

    if (!resp.ok) {
      const errData = await resp.json().catch(() => ({}));
      throw new Error(`API error ${resp.status}: ${errData.error?.message || resp.statusText}`);
    }

    const data = await resp.json();
    if (!data.content || !data.content.length) throw new Error('Empty API response');

    const text = data.content.map(c => c.text || '').filter(Boolean).join('\n');
    if (!text) throw new Error('No text in response');

    // Parse JSON
    const clean = text.replace(/```json|```/g, '').trim();
    let labels;
    try {
      labels = JSON.parse(clean);
    } catch {
      const match = clean.match(/\[[\s\S]*?\]/);
      if (match) labels = JSON.parse(match[0]);
      else throw new Error('Could not parse response: ' + clean.substring(0, 200));
    }

    if (!Array.isArray(labels)) throw new Error('Expected array, got ' + typeof labels);

    photo.labels = labels.map(l => ({ code: l.code || '', description: l.description || '', approved: false }));
    photo.analyzing = false;
    photo.error = null;

  } catch (err) {
    photo.analyzing = false;
    photo.error = err.message;
  }

  render();
}

async function analyzeAll() {
  const btn = document.getElementById('analyzeAllBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Analyzing...';

  for (const photo of photos) {
    if (photo.labels.length === 0 && !photo.analyzing) {
      await analyzePhoto(photo.id);
      await sleep(300);
    }
  }

  btn.disabled = false;
  btn.textContent = '‚ö° Analyze All Photos';
}

function resizeImage(dataUrl, maxDim, quality) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      let w = img.width, h = img.height;
      if (w > maxDim || h > maxDim) {
        const scale = maxDim / Math.max(w, h);
        w = Math.round(w * scale);
        h = Math.round(h * scale);
      }
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      resolve(canvas.toDataURL('image/jpeg', quality).split(',')[1]);
    };
    img.src = dataUrl;
  });
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ============================================================
// LABEL ACTIONS
// ============================================================
function toggleApproval(photoId, labelIdx) {
  const photo = photos.find(p => p.id === photoId);
  if (photo) { photo.labels[labelIdx].approved = !photo.labels[labelIdx].approved; render(); }
}

function removeLabel(photoId, labelIdx) {
  const photo = photos.find(p => p.id === photoId);
  if (photo) { photo.labels.splice(labelIdx, 1); render(); }
}

function approveAllForPhoto(photoId) {
  const photo = photos.find(p => p.id === photoId);
  if (photo) { photo.labels.forEach(l => l.approved = true); render(); }
}

function approveAllPhotos() {
  photos.forEach(p => p.labels.forEach(l => l.approved = true));
  render();
}

function removePhoto(photoId) {
  photos = photos.filter(p => p.id !== photoId);
  render();
}

// Edit state (only one at a time)
let editingState = null; // { photoId, labelIdx }

function startEdit(photoId, labelIdx) {
  editingState = { photoId, labelIdx };
  render();
}

function cancelEdit() {
  editingState = null;
  render();
}

function saveEdit(photoId, labelIdx) {
  const photo = photos.find(p => p.id === photoId);
  if (!photo) return;
  const codeEl = document.getElementById(`edit-code-${photoId}-${labelIdx}`);
  const descEl = document.getElementById(`edit-desc-${photoId}-${labelIdx}`);
  if (codeEl && descEl) {
    photo.labels[labelIdx].code = codeEl.value;
    photo.labels[labelIdx].description = descEl.value;
  }
  editingState = null;
  render();
}

// Add label state
let addingState = null; // photoId

function startAdd(photoId) {
  addingState = photoId;
  render();
}

function cancelAdd() {
  addingState = null;
  render();
}

function saveAdd(photoId) {
  const photo = photos.find(p => p.id === photoId);
  if (!photo) return;
  const codeEl = document.getElementById(`add-code-${photoId}`);
  const descEl = document.getElementById(`add-desc-${photoId}`);
  if (codeEl && descEl && codeEl.value) {
    photo.labels.push({ code: codeEl.value, description: descEl.value, approved: false });
  }
  addingState = null;
  render();
}

// ============================================================
// EXPORT
// ============================================================
function generateExport() {
  const address = document.getElementById('addressInput').value || '[ADDRESS]';
  const caseNum = document.getElementById('caseInput').value || '[CASE NUMBER]';
  const officer = document.getElementById('officerInput').value;
  const notes = document.getElementById('notesInput').value;
  const now = new Date();
  const dateStr = now.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });

  let out = `${address} - ${caseNum}\n`;
  out += `Pictures obtained ${dateStr}.\n`;
  if (notes) out += `${notes}\n`;
  out += `Company: Code Enforcement\n`;
  out += `Contact: ${officer}\n`;
  out += `Created: ${now.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' })}\n\n`;

  photos.forEach((photo, i) => {
    out += `(${i + 1})\n`;
    photo.labels.forEach(l => {
      out += `${l.code}; ${l.description}\n`;
    });
    out += `\n`;
  });

  return out;
}

function copyExport() {
  const text = generateExport();
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('exportBtn');
    btn.textContent = '‚úì Copied!';
    setTimeout(() => { btn.textContent = 'üìã Copy Labels to Clipboard'; }, 2000);
  });
}

// ============================================================
// RENDER
// ============================================================
function render() {
  const totalLabels = photos.reduce((s, p) => s + p.labels.length, 0);
  const approvedLabels = photos.reduce((s, p) => s + p.labels.filter(l => l.approved).length, 0);
  const allDone = totalLabels > 0 && totalLabels === approvedLabels;

  // Progress
  const pw = document.getElementById('progressWrap');
  if (totalLabels > 0) {
    pw.style.display = 'flex';
    document.getElementById('progressText').textContent = `${approvedLabels}/${totalLabels} labels approved`;
    const fill = document.getElementById('progressFill');
    fill.style.width = `${(approvedLabels / totalLabels) * 100}%`;
    fill.className = 'progress-fill' + (allDone ? ' done' : '');
  } else {
    pw.style.display = 'none';
  }

  // Action bar
  const ab = document.getElementById('actionBar');
  ab.style.display = photos.length > 0 ? 'flex' : 'none';
  document.getElementById('approveAllBtn').style.display = totalLabels > 0 ? '' : 'none';
  const exportBtn = document.getElementById('exportBtn');
  exportBtn.style.display = totalLabels > 0 ? '' : 'none';
  exportBtn.className = 'btn btn-export' + (allDone ? ' ready' : '');
  document.getElementById('photoCount').textContent = `${photos.length} photo${photos.length !== 1 ? 's' : ''}`;

  // Photo list
  const list = document.getElementById('photoList');
  list.innerHTML = '';

  photos.forEach((photo, photoIdx) => {
    const allApproved = photo.labels.length > 0 && photo.labels.every(l => l.approved);

    const card = document.createElement('div');
    card.className = 'photo-card' + (allApproved ? ' all-approved' : '');

    let labelsHtml = '';

    if (photo.analyzing) {
      labelsHtml = `<div class="analyzing-msg"><div class="spinner"></div> Analyzing photo for violations...</div>`;
    } else if (photo.error) {
      labelsHtml = `<div class="error-msg">${esc(photo.error)} <button class="btn-small" style="margin-left:12px;background:#7c3aed;color:white;" onclick="analyzePhoto(${photo.id})">Retry</button></div>`;
    } else if (photo.labels.length === 0) {
      labelsHtml = `<div class="empty-msg">No labels yet. <button class="btn-small" style="margin-left:12px;background:#7c3aed;color:white;font-weight:600;" onclick="analyzePhoto(${photo.id})">Analyze Photo</button></div>`;
    }

    // Labels
    photo.labels.forEach((label, li) => {
      if (editingState && editingState.photoId === photo.id && editingState.labelIdx === li) {
        labelsHtml += `
          <div class="edit-row">
            <input class="edit-input edit-code mono" id="edit-code-${photo.id}-${li}" value="${esc(label.code)}">
            <input class="edit-input edit-desc" id="edit-desc-${photo.id}-${li}" value="${esc(label.description)}">
            <div class="edit-actions">
              <button class="btn-small edit-save" onclick="saveEdit(${photo.id},${li})">Save</button>
              <button class="btn-small edit-cancel" onclick="cancelEdit()">Cancel</button>
            </div>
          </div>`;
      } else {
        labelsHtml += `
          <div class="label-row">
            <button class="label-checkbox${label.approved ? ' checked' : ''}" onclick="toggleApproval(${photo.id},${li})">${label.approved ? '‚úì' : ''}</button>
            <div class="label-content">
              <span class="label-code mono">${esc(label.code)}</span>
              <span class="label-sep">;</span>
              <span class="label-desc">${esc(label.description)}</span>
            </div>
            <div class="label-actions">
              <button class="label-edit-btn" onclick="startEdit(${photo.id},${li})">edit</button>
              <button class="label-remove-btn" onclick="removeLabel(${photo.id},${li})">‚úï</button>
            </div>
          </div>`;
      }
    });

    // Add label UI
    if (!photo.analyzing) {
      if (addingState === photo.id) {
        let opts = '<option value="">Select code...</option>';
        for (const [code, desc] of Object.entries(COLUMBUS_CODES)) {
          opts += `<option value="${esc(code)}">${esc(code)} - ${esc(desc.substring(0, 50))}</option>`;
        }
        labelsHtml += `
          <div class="add-row">
            <select class="add-select mono" id="add-code-${photo.id}">${opts}</select>
            <input class="edit-input edit-desc" id="add-desc-${photo.id}" placeholder="Description...">
            <div class="add-actions">
              <button class="btn-small edit-save" onclick="saveAdd(${photo.id})">Add</button>
              <button class="btn-small edit-cancel" onclick="cancelAdd()">Cancel</button>
            </div>
          </div>`;
      } else {
        labelsHtml += `<div class="label-footer">`;
        labelsHtml += `<button class="btn-add-label" onclick="startAdd(${photo.id})">+ Add Label</button>`;
        if (photo.labels.length > 0 && !allApproved) {
          labelsHtml += `<button class="btn-approve-all" onclick="approveAllForPhoto(${photo.id})">‚úì Approve All</button>`;
        }
        if (photo.labels.length > 0) {
          labelsHtml += `<button class="btn-reanalyze" onclick="analyzePhoto(${photo.id})">Re-analyze</button>`;
        }
        labelsHtml += `</div>`;
      }
    }

    card.innerHTML = `
      <div class="photo-card-inner">
        <div class="photo-img-wrap">
          <img class="photo-img" src="${photo.dataUrl}" alt="Photo ${photoIdx + 1}">
          <div class="photo-number mono">(${photoIdx + 1})</div>
          ${allApproved ? '<div class="photo-approved-badge">‚úì APPROVED</div>' : ''}
          <button class="photo-remove" onclick="removePhoto(${photo.id})">REMOVE</button>
        </div>
        <div class="labels-panel">${labelsHtml}</div>
      </div>`;

    list.appendChild(card);
  });

  // Export preview
  const exportSection = document.getElementById('exportSection');
  if (totalLabels > 0) {
    exportSection.style.display = '';
    document.getElementById('exportPre').textContent = generateExport();
  } else {
    exportSection.style.display = 'none';
  }
}

function esc(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}
</script>
</body>
</html>
